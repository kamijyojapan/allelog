# 変更履歴 (Changelog)

## [2.0.0] - 2026-02-16

### 💥 破壊的変更
- **GAS（Google Apps Script）依存を完全廃止**: サーバーレスなHTML埋め込み型レポート生成に移行

### 追加
- **HTML埋め込み型レポート機能**: 症状データをスタイル付きHTMLファイルとして生成。機械可読用のJSONデータも同時に埋め込み
- **Web Share API対応**: スマホからメール・LINE・AirDropなどで医師にレポートを直接共有可能
- **アレログ・マネージャー（manager.html）**: PC用の患者データ管理ツールを新規追加
  - 複数患者のHTMLレポートを一元管理
  - 患者名・カルテIDで検索
  - 詳細表示（症状写真、スナップショット）
  - CSV出力（Excel互換、BOM付きUTF-8）

### 改善
- **完全オフライン化**: サーバーとの通信が不要になり、圏外でもレポート作成可能
- **データサイズ制限の解消**: GAS URLサイズ制限（50MB）がなくなり、大量の写真を含むレポートも作成可能
- **プライバシー強化**: データが外部サーバーを経由しないため、セキュリティリスクが低減

### 削除
- GASサーバーへの送信機能（`sendDoctorData`のfetch処理）

### 備考
- `GAS_Script.js` は参考用に残していますが、v2.0.0以降は使用しません
- 既存のIndexedDBデータ構造は完全に互換性があり、アップデート後も過去のデータはそのまま利用可能

## [1.4.1] - 2026-02-09

### 改善
- **誘因チェックボックスの項目を簡略化**: 「その他」オプションを削除、「運動誘発性」を「運動」に変更、アイコン削除で4項目に整理

## [1.4.0] - 2026-02-09

### 追加
- **症状記録に「誘因・状況」チェックボックスを追加**: 運動、ストレス、睡眠不足、体調不良（風邪など）の4項目から選択可能に
- **詳細表示に誘因情報を追加**: 記録した誘因がタイムラインと詳細モーダルに表示されるように
- **PDFレポートに誘因情報を追加**: ドクターモードで送信するレポートにも誘因が含まれるように

## [1.3.9] - 2026-02-08

### 修正
- **PWAインストール（Android対応）**: manifest.json、index.html、sw.jsのパス設定を絶対パスに統一し、AndroidでPWAインストールが正常に動作するように改善
- **Android Chrome特有の厳格な要件に対応**: idフィールドの追加、Service Workerのscope整合性確保、beforeinstallpromptイベントの正しい処理を実装

## [1.3.8] - 2026-02-08

### 改善
- **GASコードのさらなる最適化**: 不要な関数（writeLog, recordSuccess）を削除し、コードをシンプル化
- **エラーログの削減**: 送信日時の解析エラーログを削除して処理を軽量化
- **キューベース処理の確立**: シンプルで信頼性の高いキュー処理方式に統一

## [1.3.7] - 2026-02-08

### 改善
- **GASコードの最適化**: 不要なスプレッドシートアクセスとログ処理を削除し、PDF作成処理を高速化
- **メール通知を一時無効化**: 処理速度向上のためメール通知機能をコメントアウト
- **ユーザーメッセージの改善**: 送信完了時に「1～2分以内にレポートが作成されます」と表示

## [1.3.6] - 2026-02-08

### 改善
- **レポート作成処理を最適化**: 待機時間を0秒に短縮し、1分以内にレポートが作成されるように改善
- **処理時間の可視化**: GASログに詳細な処理時間（PDF作成時間、送信から完了までの時間）を記録

## [1.3.5] - 2026-02-08

### 改善
- **送信日時の記録**: データ送信時のタイムスタンプをpayloadに含めるように改善

## GAS Script更新 - 2026-02-08

### 追加
- **送信日時をPDFレポートに記録**: レポートがいつ送信されたかをPDFに記載するようになりました
  - **重要**: テンプレートファイルに `{{SubmittedDate}}` プレースホルダーを追加する必要があります
- **送信日時をスプレッドシートに記録**: 管理シートに送信日時を記録する列を追加
  - **重要**: スプレッドシートのヘッダー行に「送信日時」列を追加する必要があります（「処理完了日時」の次）

### 修正
- **PDFの送信日時をapp.jsから受け取るように修正**: PDF作成時のサーバー時刻ではなく、実際にユーザーがアプリから送信した日時を記録するように修正

## [1.3.4] - 2026-02-08

### 改善
- **レポート作成の信頼性向上**: ファイル書き込み完了を待つため、キュー方式に変更。作成から10秒以上経過したファイルのみを処理することで、データの完全性を確保
- **処理時間の最適化**: 1〜2分以内にレポートが作成されるよう調整

## [1.3.3] - 2026-02-08

### 改善
- **レポート作成処理を高速化**: データ送信時に即座にPDF作成を試みるハイブリッド方式を採用
- **サーバー負荷を軽減**: 定期チェック処理を最適化し、キューが空の場合は早期リターンするように改善

## [1.3.2] - 2026-02-08

### 修正
- **医師用レポートで複数写真が表示されない問題を修正**: 食事記録・症状記録で添付した全ての写真が医師用PDFレポートに正しく含まれるように修正

## [1.3.1] - 2026-02-08

### 修正
- **設定画面の表示不具合を修正**: 設定画面を開いた際に、以前保存したカルテIDと患者氏名が正しく表示されるように修正

## [1.3.0] - 2026-02-07

### 追加
- **食事記録・症状記録の写真を4枚まで添付可能**: 複数の角度から食事や症状を記録できるようになりました
- **2x2グリッドレイアウト**: 写真プレビューをグリッド表示し、一覧性を向上
- **各写真に個別削除ボタン**: 不要な写真だけを削除できるようになりました
- **4枚到達時の案内メッセージ**: 上限に達したことを明確に表示

### 改善
- **既存データとの互換性**: 1枚写真の既存データも引き続き表示・編集可能
- **タイムラインでの複数枚表示**: 最初の1枚をサムネイル表示、2枚以上は右下に枚数バッジを表示
- **詳細モーダルでの複数枚表示**: 全ての写真をグリッド形式で確認可能

## [1.2.8] - 2026-02-05

### 改善
- **デバッグログに閉じるボタンを追加**: モーダル下部に閉じるボタンを配置し、操作性を向上

## [1.2.7] - 2026-02-05

### 変更
- **デバッグログトグルを削除**: 設定画面からトグルスイッチを削除し、`console.log` を常に有効にした
- **デバッグログボタンの文言・アイコン変更**: 「📋 ログを表示」を「🐛 デバッグログを表示」に更新

## [1.2.6] - 2026-02-05

### 追加
- **スナップショット日数設定**: 設定画面で症状記録時の遡り日数を変更できるようにした（デフォルト: 1日）

## [1.2.5] - 2026-02-05

### 変更
- **終了ボタンを削除**: メニューから終了ボタンを削除し、UIをシンプル化

### 改善
- **データ移行画面のUI向上**: 画面下部に「閉じる」ボタンを追加し、操作性を向上

## [1.2.4] - 2026-02-05

### 改善
- **設定画面のUI向上**: 下部に「保存して閉じる」ボタンと「閉じる」ボタンを追加し、操作性を向上

## [1.2.3] - 2026-02-05

### 追加
- **更新履歴モーダル**: 「アレログについて」から更新履歴（CHANGELOG）を全文表示できる画面を追加

### 変更
- **アレログについての文言更新**: 一般向けの説明に刷新し、使い方とデータ取り扱いを明確化

## [1.2.2] - 2026-02-05

### 改善
- **薬剤登録画面の操作性向上**: 画面下部に「閉じる」ボタンを配置し、ユーザビリティを向上

## [1.2.1] - 2026-02-04

### 修正
- **スナップショット処理の安全性向上**: 症状記録送信時にスナップショットの存在確認を改善し、食事データが空でも服薬データを正しく処理できるように修正

## [1.2.0] - 2026-02-04

### 追加
- **ドクターモード送信機能**: ドクターモード時に📤送信ボタンを表示し、症状データを月単位でGASサーバーへ送信
- **患者情報設定**: 設定画面にカルテIDと患者氏名の入力欄を追加し、localStorage で永続化
- **画像データ変換**: 症状記録の画像とスナップショット内の食事画像をBase64形式に変換して送信
- **ローディング画面**: データ送信中のローディングオーバーレイを実装
- **GAS連携**: Google Apps Script で受信したデータからPDFレポートを自動生成する仕組みに対応

### 改善
- 送信時に未入力の場合はプロンプトで入力を促し、入力内容を設定画面にも反映
- 送信確認ダイアログにカルテIDと患者氏名を表示して誤送信を防止

## [1.1.6] - 2026-02-04

### 追加
- デバッグログ機能を追加（設定画面にトグルとログ閲覧モーダルを配置）
- PWA関連イベント（Service Worker登録・beforeinstallprompt・インストール結果など）をログポイントとして収集
- ログは常に収集し、トグルはコンソール出力だけを制御する設計
- インラインスクリプトの SW 登録と beforeinstallprompt にもログポイントを追加

## [1.1.5] - 2026-02-04

### 追加
- アプリ内インストールボタンを追加（side-menu に「📲 アプリとしてインストール」項目を配置）
- Chrome の自動インストールバナーを有効にする（`beforeinstallprompt` の `preventDefault` を削除）
- インストール済み検出（`display-mode: standalone`）でボタンを自動非表示にする
- `appinstalled` イベント対応で、Chromeバナーから先にインストールされた場合にもボタンを非表示にする

## [1.1.4] - 2026-02-04

### 修正
- PWAインストールができない問題を修正（manifest.jsonに`description`フィールドを追加）
- Service Workerで`chrome-extension`等の非HTTPスキームをスキップしてエラーを修正
- Service Workerキャッシュバージョンをv10に更新

## [1.1.3] - 2026-02-04

### 改善
- Service WorkerをNetwork First戦略に変更し、HTML/JSファイルの更新が即座に反映されるように改善
- Persistent Storage APIを実装し、ブラウザのデータ削除でIndexedDBが消えるリスクを軽減
- PWAインストールプロンプトのハンドリングを追加
- Service Workerのキャッシュバージョンをv9に更新

## [1.1.2] - 2026-02-04

### 修正
- ドクターモードの切り替えが反応しない問題を修正
- 記録の日時を編集して保存した際に反映されない問題を修正

### 改善
- 症状記録の参照時に、過去1週間の食事・服薬を再集計して差分があればスナップショットを更新
- 再集計日を記録し、更新があった場合のみ軽く通知

## [1.1.0] - 2026-02-03

### 追加
- ハンバーガーメニューに「設定」画面を追加
- ハンバーガーメニューに「更新」機能を追加（ServiceWorkerの強制更新）
- 設定画面に「ドクターモード説明を再表示」機能を追加
- 下部メニューの現在位置をハイライト表示

### 改善
- モーダルの背景クリックで閉じる機能を実装
- ドクターモードの注意書きを初回のみ表示（設定から再表示可能）
- ドクターモードクリック時にカレンダー画面に自動遷移
- 初期表示時に下部メニューのホームをアクティブ表示

### 変更
- Aboutモーダルを専用画面として分離

## [1.0.0] - 2026-02-03

### 追加
- 初回リリース
- 食事記録機能（写真、タグ、メモ）
- 服薬記録機能（薬剤プリセット管理）
- 症状記録機能（重症度、部位、詳細、過去1週間の自動スナップショット）
- カレンダー表示
- タイムライン表示
- ドクターモード（症状の重症度をカレンダーに数値表示）
- データ移行機能（バックアップ・復元）
- PWA対応（オフライン動作、ホーム画面追加）
