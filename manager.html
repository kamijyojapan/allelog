<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¢ãƒ¬ãƒ­ã‚°ãƒ»ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --primary: #2196f3;
            --bg: #f5f7fa;
            --border: #e0e0e0;
            --text: #333;
        }
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            display: flex;
            height: 100vh;
            background: var(--bg);
            color: var(--text);
            overflow: hidden;
        }

        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
        .sidebar {
            width: 320px;
            background: white;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .sidebar-header {
            padding: 20px;
            background: var(--primary);
            color: white;
            font-weight: bold;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .file-count {
            font-size: 0.85rem;
            background: rgba(255,255,255,0.2);
            padding: 3px 10px;
            border-radius: 12px;
        }

        /* ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‰ãƒ­ãƒƒãƒ—ã‚¨ãƒªã‚¢ */
        .file-drop-area {
            margin: 15px;
            padding: 30px 20px;
            border: 2px dashed #ccc;
            border-radius: 8px;
            text-align: center;
            color: #666;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            background: #fafafa;
        }
        .file-drop-area:hover {
            background: #e3f2fd;
            border-color: var(--primary);
        }
        .file-drop-area.drag-over {
            background: #e3f2fd;
            border-color: var(--primary);
            transform: scale(1.02);
        }

        /* æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ */
        .search-box-container {
            padding: 0 15px 15px 15px;
        }
        .search-box {
            width: 100%;
            padding: 10px 12px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: 0.2s;
        }
        .search-box:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        /* æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */
        .date-filter-container {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            background: #f9f9f9;
        }
        .filter-label {
            font-size: 0.85rem;
            font-weight: bold;
            margin-bottom: 8px;
            color: #666;
        }
        .date-inputs {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        .date-input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.85rem;
        }
        .btn-filter, .btn-clear-filter {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            font-size: 0.85rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: 0.2s;
        }
        .btn-filter {
            background: var(--primary);
            color: white;
        }
        .btn-filter:hover {
            background: #1976d2;
        }
        .btn-clear-filter {
            background: #f5f5f5;
            color: #666;
        }
        .btn-clear-filter:hover {
            background: #e0e0e0;
        }

        /* æ‚£è€…ãƒªã‚¹ãƒˆ */
        .patient-list {
            flex: 1;
            overflow-y: auto;
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .patient-item {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.2s;
        }
        .patient-item:hover {
            background: #f5f5f5;
        }
        .patient-item.active {
            background: #e3f2fd;
            border-left: 4px solid var(--primary);
        }
        .patient-name {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 1rem;
        }
        .patient-meta {
            font-size: 0.85rem;
            color: #666;
        }

        /* ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ */
        .toolbar {
            padding: 20px 25px;
            background: white;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }
        .current-view-title {
            margin: 0;
            font-size: 1.3rem;
            color: var(--text);
        }
        .toolbar-actions {
            display: flex;
            gap: 10px;
        }

        /* ã‚¿ãƒ– */
        .view-tabs {
            display: flex;
            gap: 10px;
        }
        .tab-btn {
            padding: 10px 16px;
            border: none;
            background: #f5f5f5;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            font-size: 0.9rem;
            transition: 0.2s;
            font-family: inherit;
        }
        .tab-btn.active {
            background: white;
            font-weight: bold;
            border-bottom: 2px solid var(--primary);
        }
        .tab-btn:hover {
            background: #e8e8e8;
        }
        .tab-btn.active:hover {
            background: white;
        }

        /* ãƒœã‚¿ãƒ³ */
        .btn {
            padding: 10px 18px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
            font-weight: 500;
        }
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .btn-primary {
            background: #4caf50;
            color: white;
        }
        .btn-outline {
            background: white;
            border: 1px solid #ccc;
            color: #333;
        }

        /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ */
        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
        }

        /* ãƒ¬ãƒãƒ¼ãƒˆã‚«ãƒ¼ãƒ‰ */
        .report-card {
            background: white;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: 0.2s;
        }
        .report-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }
        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 12px;
            margin-bottom: 15px;
        }
        .report-date {
            font-weight: bold;
            color: #555;
            font-size: 1rem;
        }
        .severity-badge {
            background: #e53935;
            color: white;
            padding: 4px 12px;
            border-radius: 16px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        /* ãƒ¬ãƒãƒ¼ãƒˆè©³ç´° */
        .report-detail {
            display: grid;
            grid-template-columns: 100px 1fr;
            gap: 12px;
            font-size: 0.95rem;
            margin-bottom: 15px;
        }
        .detail-label {
            color: #666;
            font-weight: 500;
        }
        .detail-value {
            color: #333;
        }

        /* èª˜å› ã‚¿ã‚° */
        .trigger-tag {
            display: inline-block;
            background: #fff3e0;
            color: #e65100;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 0.85rem;
            margin-right: 6px;
            margin-bottom: 4px;
        }

        /* ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ */
        .snapshot {
            background: #f9f9f9;
            padding: 15px;
            margin-top: 15px;
            border-radius: 6px;
            border-left: 4px solid #4caf50;
        }
        .snapshot-title {
            font-weight: bold;
            color: #4caf50;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        .snapshot-item {
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: #555;
        }

        /* å†™çœŸã‚°ãƒªãƒƒãƒ‰ */
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }
        .photo-grid img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 6px;
            border: 2px solid var(--border);
            cursor: zoom-in;
            transition: all 0.2s;
        }
        .photo-grid img:hover {
            border-color: var(--primary);
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* ç©ºã®çŠ¶æ…‹ */
        .empty-state {
            text-align: center;
            color: #999;
            margin-top: 120px;
        }
        .empty-state h3 {
            margin-bottom: 10px;
            color: #666;
        }

        /* çµ±è¨ˆã‚°ãƒ©ãƒ• */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            padding: 20px;
        }
        .chart-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .chart-card h3 {
            margin: 0 0 15px 0;
            font-size: 1rem;
            color: #555;
        }
        .chart-card canvas {
            height: 300px !important;
        }

        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #999;
        }

        /* ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
        .menu-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 8px;
            color: var(--text);
        }

        /* ã‚µã‚¤ãƒ‰ãƒãƒ¼èƒŒæ™¯ */
        .sidebar-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
        .sidebar-backdrop.open {
            display: block;
        }

        /* ã‚¿ãƒƒãƒã‚¿ãƒ¼ã‚²ãƒƒãƒˆæœ€é©åŒ– */
        .btn {
            padding: 12px 20px;
            min-height: 44px;
        }
        .patient-item {
            padding: 18px 20px;
            min-height: 60px;
        }
        .search-box {
            padding: 12px;
            min-height: 44px;
        }

        /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆå¢ƒç•Œ: 768px */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -250px;
                width: 250px;
                z-index: 1000;
                transition: left 0.3s ease;
            }
            .sidebar.open {
                left: 0;
            }

            .menu-toggle {
                display: block;
            }

            .file-drop-area {
                border: 2px solid var(--primary);
                background: #e3f2fd;
                padding: 40px 20px;
            }
            .file-drop-area::after {
                content: 'ğŸ“± ã‚¿ãƒƒãƒ—ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ';
                display: block;
                font-size: 1.1rem;
                font-weight: bold;
                margin-top: 10px;
            }

            .stats-container {
                grid-template-columns: 1fr;
            }
        }

        /* ã‚¹ãƒãƒ›æœ€é©åŒ–: 480px */
        @media (max-width: 480px) {
            .toolbar {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            .toolbar-actions {
                width: 100%;
                justify-content: space-between;
            }
            .btn {
                font-size: 0.85rem;
                padding: 10px 14px;
            }
            .current-view-title {
                font-size: 1.1rem;
            }

            .view-tabs {
                flex-direction: column;
                gap: 5px;
                width: 100%;
            }
            .tab-btn {
                width: 100%;
                border-radius: 6px;
            }
        }

    </style>
</head>
<body>
<div class="sidebar">
    <div class="sidebar-header">
        <span>ğŸ¥ ã‚¢ãƒ¬ãƒ­ã‚°ãƒ»ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼</span>
        <span id="file-count" class="file-count">0ä»¶</span>
    </div>
    <div class="file-drop-area" id="drop-zone">
        ğŸ“‚ ã“ã“ã«HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ­ãƒƒãƒ—<br>
        <small style="color:#999;">ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦é¸æŠ</small>
        <input type="file" id="file-input" multiple accept=".html" style="display:none">
    </div>
    <div class="search-box-container">
        <input type="text" id="search-box" class="search-box" placeholder="ğŸ” æ‚£è€…åã‚„ã‚«ãƒ«ãƒ†IDã§æ¤œç´¢">
    </div>
    <div class="date-filter-container">
        <div class="filter-label">ğŸ“… æœŸé–“çµã‚Šè¾¼ã¿</div>
        <div class="date-inputs">
            <input type="date" id="filter-start" class="date-input">
            <span>ã€œ</span>
            <input type="date" id="filter-end" class="date-input">
        </div>
        <button id="apply-filter" class="btn-filter">é©ç”¨</button>
        <button id="clear-filter" class="btn-clear-filter">ã‚¯ãƒªã‚¢</button>
    </div>
    <ul class="patient-list" id="patient-list"></ul>
</div>

<div class="sidebar-backdrop" id="sidebar-backdrop"></div>

<div class="main">
    <div class="toolbar">
        <button class="menu-toggle" id="menu-toggle">â˜°</button>
        <div class="view-tabs">
            <button class="tab-btn active" data-view="detail">ğŸ“‹ è©³ç´°è¡¨ç¤º</button>
            <button class="tab-btn" data-view="stats">ğŸ“Š çµ±è¨ˆã‚°ãƒ©ãƒ•</button>
        </div>
        <h2 id="current-view-title" class="current-view-title" style="flex:1;">ãƒ¬ãƒãƒ¼ãƒˆè©³ç´°</h2>
        <div class="toolbar-actions">
            <button class="btn btn-outline" onclick="clearAll()">ğŸ—‘ï¸ ã‚¯ãƒªã‚¢</button>
            <button class="btn btn-primary" onclick="downloadCSV()">ğŸ“¥ CSVå‡ºåŠ›</button>
        </div>
    </div>
    <div class="content-area" id="content-area">
        <div class="empty-state">
            <h3>ãƒ•ã‚¡ã‚¤ãƒ«ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“</h3>
            <p>å·¦ä¸Šã®ã‚¨ãƒªã‚¢ã«ã€ã‚¹ãƒãƒ›ã‹ã‚‰é€ã‚‰ã‚ŒãŸHTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’<br>ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚</p>
        </div>
    </div>
</div>

<script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let reports = [];
    let currentReport = null;
    let dateFilter = {
        enabled: false,
        start: null,
        end: null
    };
    let charts = {};
    let currentView = 'detail';

    // èª˜å› ãƒ©ãƒ™ãƒ«ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆapp.jsã¨åŒã˜ï¼‰
    const TRIGGER_LABELS = {
        'exercise': 'é‹å‹•',
        'stress': 'ã‚¹ãƒˆãƒ¬ã‚¹',
        'sleep_lack': 'ç¡çœ ä¸è¶³',
        'illness': 'ä½“èª¿ä¸è‰¯'
    };

    // DOMè¦ç´ 
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const searchBox = document.getElementById('search-box');
    const patientList = document.getElementById('patient-list');
    const fileCount = document.getElementById('file-count');
    const contentArea = document.getElementById('content-area');
    const currentViewTitle = document.getElementById('current-view-title');
    const menuToggle = document.getElementById('menu-toggle');
    const sidebar = document.querySelector('.sidebar');
    const sidebarBackdrop = document.getElementById('sidebar-backdrop');

    // ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼å‡¦ç†
    menuToggle.addEventListener('click', () => {
        sidebar.classList.toggle('open');
        sidebarBackdrop.classList.toggle('open');
    });

    sidebarBackdrop.addEventListener('click', () => {
        sidebar.classList.remove('open');
        sidebarBackdrop.classList.remove('open');
    });

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    dropZone.onclick = () => fileInput.click();

    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('drag-over');
    });

    dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        handleFiles(e.dataTransfer.files);
    });

    fileInput.onchange = (e) => handleFiles(e.target.files);
    searchBox.oninput = renderSidebar;

    // æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å‡¦ç†
    document.getElementById('apply-filter').addEventListener('click', () => {
        const start = document.getElementById('filter-start').value;
        const end = document.getElementById('filter-end').value;

        if (!start || !end) {
            alert('é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã®ä¸¡æ–¹ã‚’é¸æŠã—ã¦ãã ã•ã„');
            return;
        }

        dateFilter.enabled = true;
        dateFilter.start = new Date(start);
        dateFilter.end = new Date(end);
        dateFilter.end.setHours(23, 59, 59, 999);

        renderSidebar();
        if (currentReport) {
            const li = document.querySelector('.patient-item.active');
            showDetail(currentReport, li);
        }
    });

    document.getElementById('clear-filter').addEventListener('click', () => {
        dateFilter.enabled = false;
        dateFilter.start = null;
        dateFilter.end = null;
        document.getElementById('filter-start').value = '';
        document.getElementById('filter-end').value = '';
        renderSidebar();
        if (currentReport) {
            const li = document.querySelector('.patient-item.active');
            showDetail(currentReport, li);
        }
    });

    // ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ã‚¸ãƒ­ã‚¸ãƒƒã‚¯ï¼šæœ€æ–°å„ªå…ˆï¼‹æ¬ æè£œå®Œï¼‰
    async function handleFiles(files) {
        for (const file of files) {
            if (!file.name.endsWith('.html')) continue;

            try {
                const text = await file.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(text, 'text/html');
                const script = doc.getElementById('raw-data');

                if (script) {
                    const json = JSON.parse(script.textContent);
                    const key = `${json.chartId}_${json.year}_${json.month}`;

                    // é‡è¤‡ãƒã‚§ãƒƒã‚¯
                    const existingIndex = reports.findIndex(r =>
                        `${r.chartId}_${r.year}_${r.month}` === key
                    );

                    if (existingIndex >= 0) {
                        // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¨ãƒãƒ¼ã‚¸ï¼ˆæœ€æ–°å„ªå…ˆï¼‹æ¬ æè£œå®Œï¼‰
                        reports[existingIndex] = mergeReports(reports[existingIndex], json);
                    } else {
                        reports.push(json);
                    }
                }
            } catch (err) {
                console.error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', err);
                alert(`ãƒ•ã‚¡ã‚¤ãƒ« "${file.name}" ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚`);
            }
        }
        renderSidebar();
    }

    // ãƒ¬ãƒãƒ¼ãƒˆãƒãƒ¼ã‚¸é–¢æ•°ï¼šæœ€æ–°ãƒ•ã‚¡ã‚¤ãƒ«å„ªå…ˆã€æ¬ æãƒ‡ãƒ¼ã‚¿ã¯å¤ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰è£œå®Œ
    function mergeReports(existing, incoming) {
        // submittedAt ã§æ–°æ—§åˆ¤å®šï¼ˆæ–°ã—ã„æ–¹ã‚’åŸºæº–ã¨ã™ã‚‹ï¼‰
        const existingTime = new Date(existing.submittedAt).getTime();
        const incomingTime = new Date(incoming.submittedAt).getTime();

        let base, supplement;
        if (incomingTime >= existingTime) {
            // æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åŸºæº–ã€å¤ã„ãƒ•ã‚¡ã‚¤ãƒ«ã§è£œå®Œ
            base = incoming;
            supplement = existing;
        } else {
            // æ—¢å­˜ãŒæ–°ã—ã„å ´åˆã¯ã€æ—¢å­˜ã‚’åŸºæº–ã€æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ã§è£œå®Œ
            base = existing;
            supplement = incoming;
        }

        // itemsé…åˆ—ã®ãƒãƒ¼ã‚¸ï¼ˆIDãƒ™ãƒ¼ã‚¹ï¼‰
        const mergedItemsMap = new Map();

        // åŸºæº–ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ã‚’å„ªå…ˆçš„ã«æ ¼ç´
        base.items.forEach(item => {
            mergedItemsMap.set(item.id, item);
        });

        // è£œå®Œãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã€åŸºæº–ã«ãªã„ãƒ‡ãƒ¼ã‚¿ã®ã¿è¿½åŠ ï¼ˆæ¬ æè£œå®Œï¼‰
        supplement.items.forEach(item => {
            if (!mergedItemsMap.has(item.id)) {
                mergedItemsMap.set(item.id, item);
            }
        });

        // IDã§ã‚½ãƒ¼ãƒˆï¼ˆæ™‚ç³»åˆ—é †ï¼‰
        const mergedItems = Array.from(mergedItemsMap.values())
            .sort((a, b) => b.id - a.id); // æ–°ã—ã„é †

        return {
            ...base,
            items: mergedItems,
            _mergedFrom: `${base.submittedAt} (base) + ${supplement.submittedAt} (è£œå®Œ)`
        };
    }

    // ã‚µã‚¤ãƒ‰ãƒãƒ¼æç”»
    function renderSidebar() {
        const filter = searchBox.value.toLowerCase();
        patientList.innerHTML = '';
        fileCount.textContent = `${reports.length}ä»¶`;

        const filteredReports = reports.filter(r =>
            r.patientName.toLowerCase().includes(filter) ||
            r.chartId.toLowerCase().includes(filter)
        );

        if (filteredReports.length === 0 && reports.length > 0) {
            patientList.innerHTML = '<li style="padding:20px; text-align:center; color:#999;">æ¤œç´¢çµæœãªã—</li>';
            return;
        }

        filteredReports.forEach((r) => {
            const li = document.createElement('li');
            li.className = 'patient-item';
            li.innerHTML = `
                <div class="patient-name">${escapeHtml(r.patientName)}</div>
                <div class="patient-meta">
                    ID: ${escapeHtml(r.chartId)} | ${r.year}å¹´${r.month}æœˆ
                </div>
            `;
            li.onclick = () => showDetail(r, li);
            patientList.appendChild(li);
        });
    }

    // è©³ç´°è¡¨ç¤º
    function showDetail(report, liElement) {
        currentReport = report;

        // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã®æ›´æ–°
        document.querySelectorAll('.patient-item').forEach(e => e.classList.remove('active'));
        if (liElement) liElement.classList.add('active');

        // ã‚¿ã‚¤ãƒˆãƒ«æ›´æ–°
        let titleText = `${report.patientName} æ§˜ï¼ˆ${report.year}å¹´${report.month}æœˆï¼‰`;
        if (dateFilter.enabled) {
            const startStr = dateFilter.start.toLocaleDateString('ja-JP');
            const endStr = dateFilter.end.toLocaleDateString('ja-JP');
            titleText += ` [${startStr} ã€œ ${endStr}]`;
        }
        currentViewTitle.textContent = titleText;

        // ã‚¢ã‚¤ãƒ†ãƒ ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        let items = report.items;
        if (dateFilter.enabled) {
            items = items.filter(item => {
                const itemDate = new Date(item.id);
                return itemDate >= dateFilter.start && itemDate <= dateFilter.end;
            });
        }

        if (items.length === 0) {
            contentArea.innerHTML = '<div class="empty-state"><h3>è©²å½“ã™ã‚‹è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</h3></div>';
            return;
        }

        // ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        let html = '';
        items.forEach(item => {
            const date = new Date(item.id);

            // èª˜å› ã‚¿ã‚°
            const triggersHtml = (item.triggers || [])
                .map(t => `<span class="trigger-tag">${TRIGGER_LABELS[t] || t}</span>`)
                .join('');

            // ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆ
            let snapshotHtml = '';
            if (item.snapshot) {
                const mealsHtml = (item.snapshot.meals || [])
                    .map(m => `<div class="snapshot-item">ğŸ½ï¸ ${escapeHtml(m.tags.join(', '))}</div>`)
                    .join('');
                const medsHtml = (item.snapshot.meds || [])
                    .map(m => {
                        const medList = m.items.map(i => `${escapeHtml(i.name)}(${i.count})`).join(', ');
                        return `<div class="snapshot-item">ğŸ’Š ${medList}</div>`;
                    })
                    .join('');

                if (mealsHtml || medsHtml) {
                    snapshotHtml = `
                        <div class="snapshot">
                            <div class="snapshot-title">ğŸ“ ç—‡çŠ¶ç™ºç”Ÿå‰ã®è¨˜éŒ²ï¼ˆè‡ªå‹•ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼‰</div>
                            ${mealsHtml}
                            ${medsHtml}
                        </div>
                    `;
                }
            }

            // å†™çœŸã‚°ãƒªãƒƒãƒ‰
            const photosHtml = item.photos && item.photos.length > 0
                ? `<div class="photo-grid">
                    ${item.photos.map(p => `<img src="${p}" onclick="window.open(this.src)" alt="ç—‡çŠ¶å†™çœŸ">`).join('')}
                   </div>`
                : '';

            html += `
                <div class="report-card">
                    <div class="report-header">
                        <span class="report-date">${date.toLocaleString('ja-JP')}</span>
                        <span class="severity-badge">é‡ç—‡åº¦ Lv.${item.severity}</span>
                    </div>
                    <div class="report-detail">
                        <div class="detail-label">éƒ¨ä½</div>
                        <div class="detail-value">${escapeHtml(item.parts || '-')}</div>

                        <div class="detail-label">èª˜å› ãƒ»çŠ¶æ³</div>
                        <div class="detail-value">${triggersHtml || '-'}</div>

                        <div class="detail-label">è©³ç´°ãƒ¡ãƒ¢</div>
                        <div class="detail-value" style="white-space: pre-wrap;">${escapeHtml(item.note || '-')}</div>
                    </div>
                    ${snapshotHtml}
                    ${photosHtml}
                </div>
            `;
        });

        contentArea.innerHTML = html;
    }

    // CSVå‡ºåŠ›
    function downloadCSV() {
        if (reports.length === 0) {
            alert('ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
            return;
        }

        let csv = 'ã‚«ãƒ«ãƒ†ID,æ‚£è€…æ°å,å¯¾è±¡å¹´,å¯¾è±¡æœˆ,æ—¥æ™‚,é‡ç—‡åº¦,éƒ¨ä½,èª˜å› ,è©³ç´°ãƒ¡ãƒ¢,ç›´å‰ã®é£Ÿäº‹ã‚¿ã‚°,æœè–¬å†…å®¹\n';

        reports.forEach(r => {
            r.items.forEach(item => {
                const date = new Date(item.id).toLocaleString('ja-JP');
                const triggers = (item.triggers || [])
                    .map(t => TRIGGER_LABELS[t] || t)
                    .join('/');

                let mealsStr = '';
                let medsStr = '';
                if (item.snapshot) {
                    if (item.snapshot.meals) {
                        mealsStr = item.snapshot.meals
                            .map(m => m.tags.join(' '))
                            .join(' | ');
                    }
                    if (item.snapshot.meds) {
                        medsStr = item.snapshot.meds
                            .map(m => m.items.map(i => `${i.name}(${i.count})`).join(' '))
                            .join(' | ');
                    }
                }

                const row = [
                    r.chartId,
                    r.patientName,
                    r.year,
                    r.month,
                    date,
                    item.severity,
                    item.parts || '',
                    triggers,
                    item.note || '',
                    mealsStr,
                    medsStr
                ].map(v => `"${(v || '').toString().replace(/"/g, '""')}"`).join(',');

                csv += row + '\n';
            });
        });

        // BOMä»˜ãUTF-8ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆExceläº’æ›ï¼‰
        const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `allelog_export_${new Date().toISOString().slice(0, 10)}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // ã‚¯ãƒªã‚¢
    function clearAll() {
        if (reports.length === 0) return;

        if (confirm('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
            reports = [];
            currentReport = null;
            renderSidebar();
            contentArea.innerHTML = `
                <div class="empty-state">
                    <h3>ãƒ‡ãƒ¼ã‚¿ãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã—ãŸ</h3>
                    <p>æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚</p>
                </div>
            `;
            currentViewTitle.textContent = 'ãƒ¬ãƒãƒ¼ãƒˆè©³ç´°';
        }
    }

    // ãƒ‡ãƒ¼ã‚¿é›†è¨ˆ
    function generateStats(report) {
        let items = report.items;
        if (dateFilter.enabled) {
            items = items.filter(item => {
                const itemDate = new Date(item.id);
                return itemDate >= dateFilter.start && itemDate <= dateFilter.end;
            });
        }

        // 1. æ—¥åˆ¥ã®ç—‡çŠ¶é »åº¦
        const dailyFrequency = {};
        items.forEach(item => {
            const date = new Date(item.id).toLocaleDateString('ja-JP');
            dailyFrequency[date] = (dailyFrequency[date] || 0) + 1;
        });

        // 2. é‡ç—‡åº¦ã®æ¨ç§»
        const severityData = items.map(item => ({
            date: new Date(item.id).toLocaleDateString('ja-JP'),
            severity: item.severity
        })).sort((a, b) => new Date(a.date) - new Date(b.date));

        // 3. ãƒˆãƒªã‚¬ãƒ¼ã®é›†è¨ˆ
        const triggerCounts = { exercise: 0, stress: 0, sleep_lack: 0, illness: 0 };
        items.forEach(item => {
            (item.triggers || []).forEach(t => {
                if (triggerCounts[t] !== undefined) triggerCounts[t]++;
            });
        });

        // 4. éƒ¨ä½åˆ¥ç™ºç”Ÿå›æ•°
        const partsCounts = {};
        items.forEach(item => {
            if (item.parts) {
                partsCounts[item.parts] = (partsCounts[item.parts] || 0) + 1;
            }
        });

        return { dailyFrequency, severityData, triggerCounts, partsCounts };
    }

    // çµ±è¨ˆã‚°ãƒ©ãƒ•è¡¨ç¤º
    function showStats(report) {
        Object.values(charts).forEach(chart => chart.destroy());
        charts = {};

        const stats = generateStats(report);

        contentArea.innerHTML = `
            <div class="stats-container">
                <div class="chart-card"><h3>ğŸ“Š ç—‡çŠ¶ã®é »åº¦</h3><canvas id="chart-frequency"></canvas></div>
                <div class="chart-card"><h3>ğŸ“ˆ é‡ç—‡åº¦ã®æ¨ç§»</h3><canvas id="chart-severity"></canvas></div>
                <div class="chart-card"><h3>ğŸ¯ èª˜å› ãƒ»çŠ¶æ³ã®å†…è¨³</h3><canvas id="chart-triggers"></canvas></div>
                <div class="chart-card"><h3>ğŸ“ éƒ¨ä½åˆ¥ç™ºç”Ÿå›æ•°</h3><canvas id="chart-parts"></canvas></div>
            </div>
        `;

        // ç—‡çŠ¶ã®é »åº¦ï¼ˆæ£’ã‚°ãƒ©ãƒ•ï¼‰
        charts.frequency = new Chart(document.getElementById('chart-frequency'), {
            type: 'bar',
            data: {
                labels: Object.keys(stats.dailyFrequency),
                datasets: [{ label: 'ç™ºç”Ÿå›æ•°', data: Object.values(stats.dailyFrequency), backgroundColor: '#2196f3' }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });

        // é‡ç—‡åº¦ã®æ¨ç§»ï¼ˆæŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•ï¼‰
        charts.severity = new Chart(document.getElementById('chart-severity'), {
            type: 'line',
            data: {
                labels: stats.severityData.map(d => d.date),
                datasets: [{ label: 'é‡ç—‡åº¦', data: stats.severityData.map(d => d.severity), borderColor: '#e53935', backgroundColor: 'rgba(229, 57, 53, 0.1)', tension: 0.3 }]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 5, ticks: { stepSize: 1 } } } }
        });

        // ãƒˆãƒªã‚¬ãƒ¼ã®é›†è¨ˆï¼ˆå††ã‚°ãƒ©ãƒ•ï¼‰
        const TRIGGER_LABELS_JP = { exercise: 'é‹å‹•', stress: 'ã‚¹ãƒˆãƒ¬ã‚¹', sleep_lack: 'ç¡çœ ä¸è¶³', illness: 'ä½“èª¿ä¸è‰¯' };
        charts.triggers = new Chart(document.getElementById('chart-triggers'), {
            type: 'doughnut',
            data: {
                labels: Object.keys(stats.triggerCounts).map(k => TRIGGER_LABELS_JP[k]),
                datasets: [{ data: Object.values(stats.triggerCounts), backgroundColor: ['#ff9800', '#9c27b0', '#3f51b5', '#4caf50'] }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });

        // éƒ¨ä½åˆ¥ç™ºç”Ÿå›æ•°ï¼ˆæ¨ªæ£’ã‚°ãƒ©ãƒ•ï¼‰
        charts.parts = new Chart(document.getElementById('chart-parts'), {
            type: 'bar',
            data: {
                labels: Object.keys(stats.partsCounts),
                datasets: [{ label: 'ç™ºç”Ÿå›æ•°', data: Object.values(stats.partsCounts), backgroundColor: '#4caf50' }]
            },
            options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } } }
        });
    }

    // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const view = e.target.dataset.view;
            currentView = view;

            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');

            if (currentReport) {
                if (view === 'detail') {
                    showDetail(currentReport, document.querySelector('.patient-item.active'));
                } else if (view === 'stats') {
                    showStats(currentReport);
                }
            }
        });
    });

</script>
</body>
</html>
